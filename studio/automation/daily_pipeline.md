# Daily Pipeline Agent

## 功能定义
一键执行完整的创作流水线，从章节生成到质量检查的全自动化流程。

## 适用场景
- 日常创作更新
- 批量章节生成
- 自动化连载

## 执行流程

```
┌─────────────────────────────────────────────────────────┐
│                    Daily Pipeline                        │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌─────────────────────────────────────────────────┐    │
│  │ Stage 1: 准备阶段                                │    │
│  ├─────────────────────────────────────────────────┤    │
│  │ • 读取当前章节数                                 │    │
│  │ • 加载核心上下文                                 │    │
│  │ • 检查记忆库状态                                 │    │
│  └─────────────────────────────────────────────────┘    │
│                         ↓                               │
│  ┌─────────────────────────────────────────────────┐    │
│  │ Stage 2: 规划阶段                                │    │
│  ├─────────────────────────────────────────────────┤    │
│  │ • 调用 chapter_planner                           │    │
│  │ • 生成章节计划                                   │    │
│  │ • 确认大纲位置                                   │    │
│  └─────────────────────────────────────────────────┘    │
│                         ↓                               │
│  ┌─────────────────────────────────────────────────┐    │
│  │ Stage 3: 创作阶段                                │    │
│  ├─────────────────────────────────────────────────┤    │
│  │ • 调用 writer                                    │    │
│  │ • 生成正文内容                                   │    │
│  │ • 字数达标检查                                   │    │
│  └─────────────────────────────────────────────────┘    │
│                         ↓                               │
│  ┌─────────────────────────────────────────────────┐    │
│  │ Stage 4: 质检阶段                                │    │
│  ├─────────────────────────────────────────────────┤    │
│  │ • 调用 style_controller                          │    │
│  │ • 调用 consistency_check                         │    │
│  │ • 生成质量报告                                   │    │
│  └─────────────────────────────────────────────────┘    │
│                         ↓                               │
│  ┌─────────────────────────────────────────────────┐    │
│  │ Stage 5: 记忆更新                                │    │
│  ├─────────────────────────────────────────────────┤    │
│  │ • 调用 memory_update                             │    │
│  │ • 更新所有记忆文件                               │    │
│  │ • 记录重要变更                                   │    │
│  └─────────────────────────────────────────────────┘    │
│                         ↓                               │
│  ┌─────────────────────────────────────────────────┐    │
│  │ Stage 6: 收尾阶段                                │    │
│  ├─────────────────────────────────────────────────┤    │
│  │ • 保存最终版本                                   │    │
│  │ • 更新状态文件                                   │    │
│  │ • 生成执行报告                                   │    │
│  └─────────────────────────────────────────────────┘    │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

## 输入参数
可选参数：
- `--skip-check` 跳过质量检查
- `--dry-run` 只生成计划不写正文
- `--chapters=N` 连续生成N章

## 输出
1. 章节文件：`production/chapters/第X章_*.md`
2. 质量报告：`state/quality_report_X.md`
3. 执行报告：`state/pipeline_report_[日期].md`

## 执行报告格式

```markdown
# 流水线执行报告

## 执行时间
- 开始：YYYY-MM-DD HH:MM:SS
- 结束：YYYY-MM-DD HH:MM:SS
- 耗时：XX分钟

## 执行结果

### 生成的章节
| 章节 | 标题 | 字数 | 状态 |
|-----|-----|-----|-----|
| X | ... | XXXX | ✅ 完成 |

### 质量检查结果
| 检查项 | 结果 | 问题数 |
|-------|-----|-------|
| 文风一致性 | 通过 | 0 |
| 设定一致性 | 通过 | 0 |
| 人物一致性 | 通过 | 0 |

### 记忆更新
- 新增设定：X项
- 人物更新：X项
- 伏笔操作：X项

## 警告/错误
[如有问题则列出]

## 下一步建议
- [ ] 人工审阅章节内容
- [ ] 检查并修复问题
- [ ] 确认发布
```

## 调用方式
```
@daily_pipeline
@daily_pipeline --chapters=3
@daily_pipeline --dry-run
```

## 配置文件
`state/pipeline_config.txt`：

```
# 目标字数
target_word_count=2500

# 是否自动跳过检查
auto_skip_check=false

# 是否生成后自动更新记忆
auto_memory_update=true

# 最大连续生成章节数
max_continuous_chapters=5

# 质量检查阈值（低于此分数需要人工确认）
quality_threshold=7
```

## 异常处理
| 异常类型 | 处理方式 |
|---------|---------|
| 设定冲突 | 暂停，报告冲突详情 |
| 记忆库损坏 | 尝试恢复，失败则报告 |
| 字数不达标 | 自动补充，记录警告 |
| 质量过低 | 暂停，提示人工介入 |

## 推荐使用方式
1. 首次使用：`@daily_pipeline --dry-run` 先看计划
2. 日常创作：`@daily_pipeline` 单章生成
3. 批量创作：`@daily_pipeline --chapters=N` 批量生成
